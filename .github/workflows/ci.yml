name: CI

on:
    push:
        branches:
            - main
        tags:
            - 'v*'
    pull_request:
        branches:
            - main

jobs:
    build:
        permissions:
            contents: write
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install jj (Jujutsu)
              uses: taiki-e/install-action@v2
              with:
                  tool: jj-cli

            - name: Install Dependencies
              run: npm ci

            - name: Lint
              if: runner.os == 'Linux'
              run: npm run lint

            - name: Check Types
              if: runner.os == 'Linux'
              run: npm run check-types

            - name: Run Unit Tests
              run: npm run test:unit

            - name: Run Integration Tests (Linux)
              if: runner.os == 'Linux'
              run: xvfb-run -a npm run test:integration

            - name: Run Integration Tests (macOS/Windows)
              if: runner.os != 'Linux'
              run: npm run test:integration

            - name: Package Extension
              if: runner.os == 'Linux'
              run: npx @vscode/vsce package

            - name: Generate Release Info
              if: runner.os == 'Linux'
              id: release_info
              run: |
                  VERSION=$(jq -r .version package.json)
                  TIMESTAMP=$(date +'%Y%m%d-%H%M')
                  VSIX_NAME="jj-view-${VERSION}-${TIMESTAMP}.vsix"
                  echo "vsix_name=${VSIX_NAME}" >> $GITHUB_OUTPUT

                  # Rename the VSIX
                  mv *.vsix "${VSIX_NAME}"

                  # Generate Changelog
                  echo "changes<<EOF" >> $GITHUB_OUTPUT
                  echo "### Changes in build ${TIMESTAMP}" >> $GITHUB_OUTPUT
                  echo "" >> $GITHUB_OUTPUT

                  # Find the last tag matching v*
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")

                  if [ -n "$PREVIOUS_TAG" ]; then
                    echo "Showing changes since ${PREVIOUS_TAG}:" >> $GITHUB_OUTPUT
                    git log "${PREVIOUS_TAG}..HEAD" --pretty=format:"- [%h](https://github.com/${{ github.repository }}/commit/%H) %s" >> $GITHUB_OUTPUT
                  else
                    echo "No previous release found. Showing last 20 commits:" >> $GITHUB_OUTPUT
                    git log -n 20 --pretty=format:"- [%h](https://github.com/${{ github.repository }}/commit/%H) %s" >> $GITHUB_OUTPUT
                  fi

                  echo "" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Upload Artifact
              if: runner.os == 'Linux'
              uses: actions/upload-artifact@v4
              with:
                  name: jj-view-extension
                  path: ${{ steps.release_info.outputs.vsix_name }}

            - name: Update Prerelease
              if: runner.os == 'Linux' && github.ref == 'refs/heads/main'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: prerelease
                  prerelease: true
                  files: ${{ steps.release_info.outputs.vsix_name }}
                  body: ${{ steps.release_info.outputs.changes }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Release
              if: startsWith(github.ref, 'refs/tags/') && runner.os == 'Linux'
              uses: softprops/action-gh-release@v1
              with:
                  files: ${{ steps.release_info.outputs.vsix_name }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
